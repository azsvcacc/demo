# List of IP restrictions by CIDR ranges
variable "ip_cidr_restrictions" {
  description = "List of IP addresses or CIDR ranges to allow access."
  type        = list(string)
  default     = [
    "168.183.0.0/16",
    "149.111.0.0/16",
    "128.35.0.0/16",
    "161.249.0.0/16",
    "198.203.174.0/23",
    "198.203.176.0/22",
    "198.203.180.0/23",
    "40.70.215.155/32"
  ]
}

# List of service tag restrictions
variable "service_tag_restrictions" {
  description = "List of service tag rules with name, priority, action, and service tag."
  type = list(object({
    name        = string
    priority    = number
    action      = string
    service_tag = string
  }))

  default = [
    {
      name        = "FrontdoorRule"
      priority    = 100
      action      = "Allow"
      service_tag = "AzureFrontDoor.Backend"
    }
  ]
}

######################################

  # Apply service tag restrictions
  dynamic "ip_restriction" {
    for_each = var.service_tag_restrictions
    content {
      name        = ip_restriction.value.name
      priority    = ip_restriction.value.priority
      action      = ip_restriction.value.action
      service_tag = ip_restriction.value.service_tag
    }


# List of service tag restrictions
service_tag_restrictions = [
  {
    name        = "FrontdoorRule"
    priority    = 100
    action      = "Allow"
    service_tag = "AzureFrontDoor.Backend"
  }
]


# Define the App Service slot
resource "azurerm_app_service_slot" "example_slot" {
  name                = "${var.app_name}-slot"
  location            = azurerm_app_service.example_app.location
  resource_group_name = azurerm_resource_group.example_rg.name
  app_service_plan_id = azurerm_app_service_plan.example_asp.id
  app_service_name    = azurerm_app_service.example_app.name  # Use app_service_name instead of app_service_id

  site_config {
    http2_enabled = "true"

    dynamic "ip_restriction" {
      for_each = var.ip_restrictions
      content {
        ip_address = ip_restriction.value
      }
    }

    # Apply service tag restrictions
    dynamic "ip_restriction" {
      for_each = var.service_tag_restrictions
      content {
        name        = ip_restriction.value.name
        priority    = ip_restriction.value.priority
        action      = ip_restriction.value.action
        service_tag = ip_restriction.value.service_tag
      }
    }
  }

  app_settings = {
    "ENVIRONMENT" = var.environment
  }

  tags = {
    Environment = var.environment
    AppName     = "${var.app_name}-slot"
  }
}
#############################

app_settings = {
    "ENVIRONMENT" = var.environment
    "X-Forwarded-Host" = "${azurerm_app_service.example_app.default_site_hostname}"  # Custom header example
    "X-Forwarded-For" = "{client_ip}"  # This may need to be handled in your application code
    "X-Azure-FDID" = "{azure_fd_id}"  # More relevant for Azure Front Door
    "X-FD-HealthProbe" = "healthprobe"  # Custom health probe value
  }

#########################

  app_settings = {
    "ENVIRONMENT" = var.environment
    "X-Forwarded-Host" = ""  # Custom header example
    "X-Forwarded-For" = ""  # This may need to be handled in your application code
    "X-Azure-FDID" = "38383-fgfg-fff"  # This is more relevant for Azure Front Door
    "X-FD-HealthProbe" = ""  # Custom health probe value
  }
##################################

export ARM_CLIENT_ID="<your-service-principal-client-id>"
export ARM_CLIENT_SECRET="<your-service-principal-client-secret>"
export ARM_SUBSCRIPTION_ID="<your-subscription-id>"
export ARM_TENANT_ID="<your-tenant-id>"
