name: Auto PR Creation with Reviewers

on:
  push:
    branches:
      - stage

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: stage
          base: master
          title: "Automated PR: Stage to Master"
          body: |
            This PR was automatically created.
          reviewers: approver-username # Replace with the GitHub username of the approver

      - name: Notify Approver
        run: echo "Pull request created. Approver: approver-username"

##############################################################

name: Stage to Prod Merge Workflow

on:
  push:
    branches:
      - stage # Trigger when changes are pushed to the stage branch

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: prod # Target branch for the pull request
          branch: stage # Source branch for the pull request
          title: "Merge Stage to Prod"
          body: |
            This is an automated pull request to merge changes from `stage` to `prod`.

  manual-approval:
    needs: create-pr
    runs-on: ubuntu-latest
    environment:
      name: production # Environment requiring manual approval
    steps:
      - name: Await Manual Approval
        run: echo "Manual approval required before merging."

  auto-merge:
    needs: manual-approval
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Merge Pull Request
        uses: peter-evans/merge-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request: ${{ needs.create-pr.outputs.pull-request-number }}
          merge-method: squash # Options: merge, squash, or rebase

