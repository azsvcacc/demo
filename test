# List of IP restrictions by CIDR ranges
variable "ip_cidr_restrictions" {
  description = "List of IP addresses or CIDR ranges to allow access."
  type        = list(string)
  default     = [
    "168.183.0.0/16",
    "149.111.0.0/16",
    "128.35.0.0/16",
    "161.249.0.0/16",
    "198.203.174.0/23",
    "198.203.176.0/22",
    "198.203.180.0/23",
    "40.70.215.155/32"
  ]
}

# List of service tag restrictions
variable "service_tag_restrictions" {
  description = "List of service tag rules with name, priority, action, and service tag."
  type = list(object({
    name        = string
    priority    = number
    action      = string
    service_tag = string
  }))

  default = [
    {
      name        = "FrontdoorRule"
      priority    = 100
      action      = "Allow"
      service_tag = "AzureFrontDoor.Backend"
    }
  ]
}

######################################

  # Apply service tag restrictions
  dynamic "ip_restriction" {
    for_each = var.service_tag_restrictions
    content {
      name        = ip_restriction.value.name
      priority    = ip_restriction.value.priority
      action      = ip_restriction.value.action
      service_tag = ip_restriction.value.service_tag
    }


# List of service tag restrictions
service_tag_restrictions = [
  {
    name        = "FrontdoorRule"
    priority    = 100
    action      = "Allow"
    service_tag = "AzureFrontDoor.Backend"
  }
]


# Define the App Service slot
resource "azurerm_app_service_slot" "example_slot" {
  name                = "${var.app_name}-slot"
  location            = azurerm_app_service.example_app.location
  resource_group_name = azurerm_resource_group.example_rg.name
  app_service_plan_id = azurerm_app_service_plan.example_asp.id
  app_service_name    = azurerm_app_service.example_app.name  # Use app_service_name instead of app_service_id

  site_config {
    http2_enabled = "true"

    dynamic "ip_restriction" {
      for_each = var.ip_restrictions
      content {
        ip_address = ip_restriction.value
      }
    }

    # Apply service tag restrictions
    dynamic "ip_restriction" {
      for_each = var.service_tag_restrictions
      content {
        name        = ip_restriction.value.name
        priority    = ip_restriction.value.priority
        action      = ip_restriction.value.action
        service_tag = ip_restriction.value.service_tag
      }
    }
  }

  app_settings = {
    "ENVIRONMENT" = var.environment
  }

  tags = {
    Environment = var.environment
    AppName     = "${var.app_name}-slot"
  }
}
#############################

app_settings = {
    "ENVIRONMENT" = var.environment
    "X-Forwarded-Host" = "${azurerm_app_service.example_app.default_site_hostname}"  # Custom header example
    "X-Forwarded-For" = "{client_ip}"  # This may need to be handled in your application code
    "X-Azure-FDID" = "{azure_fd_id}"  # More relevant for Azure Front Door
    "X-FD-HealthProbe" = "healthprobe"  # Custom health probe value
  }

#########################

  app_settings = {
    "ENVIRONMENT" = var.environment
    "X-Forwarded-Host" = ""  # Custom header example
    "X-Forwarded-For" = ""  # This may need to be handled in your application code
    "X-Azure-FDID" = "38383-fgfg-fff"  # This is more relevant for Azure Front Door
    "X-FD-HealthProbe" = ""  # Custom health probe value
  }
##################################

export ARM_CLIENT_ID="<your-service-principal-client-id>"
export ARM_CLIENT_SECRET="<your-service-principal-client-secret>"
export ARM_SUBSCRIPTION_ID="<your-subscription-id>"
export ARM_TENANT_ID="<your-tenant-id>"
_______________#_________________
To write a Terraform script for associating a domain with an endpoint and route in Azure Front Door, you can use the azurerm_cdn_frontdoor_custom_domain resource and link it to your endpoints and routes. Below is an example Terraform script based on the information in the screenshot.

Example Terraform Script

provider "azurerm" {
  features {}
}

resource "azurerm_cdn_frontdoor_custom_domain" "example" {
  name                = "pvmatch-stage-beta"
  profile_name        = "fdr-pc-premium-nonprod"
  resource_group_name = "your_resource_group_name"
  host_name           = "pvmatch-stage-beta.pharmacycentral-np.optum.com"
}

resource "azurerm_cdn_frontdoor_custom_domain_association" "example" {
  profile_name           = "fdr-pc-premium-nonprod"
  resource_group_name    = "your_resource_group_name"
  custom_domain_name     = azurerm_cdn_frontdoor_custom_domain.example.name
  endpoint_name          = "pvmatch-stage-endpoint-adedzcn0hugafis"
  route_name             = "pvmatch-stage-beta-route"
}

Steps to Adapt the Script

1. Replace Placeholders:

Replace your_resource_group_name with the name of your Azure resource group.

Update profile_name, custom_domain_name, endpoint_name, and route_name with the values from your Azure configuration.



2. Validation: Ensure that the azurerm provider version supports azurerm_cdn_frontdoor_custom_domain and azurerm_cdn_frontdoor_custom_domain_association. Run terraform init to initialize the configuration.


3. Apply the Configuration: Use the following commands to deploy:

terraform plan
terraform apply




This script assumes you're using Azure Front Door Premium, based on your context. If your Front Door setup differs, adjustments might be necessary.
